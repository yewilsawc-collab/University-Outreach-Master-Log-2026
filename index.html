<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Academic Agent Pro | Ph.D. Command Center</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
  <style>
    .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; }
    .active-tab { border-bottom: 3px solid #3b82f6; color: #3b82f6 !important; }
  </style>
  <script id="firebase-config" type="application/json">
  {
    "apiKey": "AIzaSyB9fmgduk-bcSRTPL6FdcKKgqvTtQoICpE",
    "authDomain": "university-outreach-log.firebaseapp.com",
    "projectId": "university-outreach-log",
    "storageBucket": "university-outreach-log.firebasestorage.app",
    "messagingSenderId": "566149647802",
    "appId": "1:566149647802:web:490c7cc3d10b7cd7732183"
  }
  </script>
</head>
<body class="min-h-screen flex flex-col overflow-x-hidden">
  <header class="sticky top-0 z-50 glass p-4 flex justify-between items-center">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center font-black text-white shadow-lg">Y</div>
      <div>
        <h1 class="text-[10px] font-black uppercase tracking-widest text-blue-400">Academic Agent Pro</h1>
        <p id="auth-status" class="text-[8px] text-slate-500 uppercase font-bold italic">Initializing System...</p>
      </div>
    </div>
    <div class="flex gap-2">
        <div id="stats-total" class="bg-slate-800/50 px-3 py-1 rounded-lg text-[9px] font-bold text-emerald-400 border border-emerald-500/20">0 Unis</div>
        <button onclick="window.exportAllData()" class="bg-slate-800 p-2 rounded-lg text-xs" title="Backup JSON">ðŸ’¾</button>
    </div>
  </header>
  <nav class="sticky top-[73px] z-40 bg-[#0f172a] border-b border-slate-800 flex overflow-x-auto no-scrollbar">
    <button onclick="window.switchTab('log')" id="tab-log" class="flex-1 min-w-[80px] py-4 text-[9px] font-black uppercase tracking-widest active-tab">Log</button>
    <button onclick="window.switchTab('chat')" id="tab-chat" class="flex-1 min-w-[80px] py-4 text-[9px] font-black uppercase tracking-widest text-slate-500">Advisor</button>
    <button onclick="window.switchTab('docs')" id="tab-docs" class="flex-1 min-w-[80px] py-4 text-[9px] font-black uppercase tracking-widest text-slate-500">Files</button>
    <button onclick="window.switchTab('vault')" id="tab-vault" class="flex-1 min-w-[80px] py-4 text-[9px] font-black uppercase tracking-widest text-slate-500">Vault</button>
    <button onclick="window.switchTab('settings')" id="tab-settings" class="flex-1 min-w-[80px] py-4 text-[9px] font-black uppercase tracking-widest text-slate-500">Auth</button>
  </nav>

  <main id="swipe-zone" class="flex-1 relative p-4 pb-32" style="touch-action: pan-y;">
    <div id="log-view" class="space-y-4">
        <div class="flex justify-between items-center mb-2">
            <h2 class="text-[10px] font-black uppercase text-slate-500">Ph.D. Target List</h2>
            <button onclick="window.deleteMultiple()" class="text-[8px] text-red-400 uppercase font-bold">Delete Multiple</button>
        </div>
        <div id="uni-list" class="space-y-3"></div>
    </div>
    
    <div id="chat-view" class="hidden h-full flex flex-col">
        <div id="chat-messages" class="flex-1 overflow-y-auto space-y-4 no-scrollbar pb-20"></div>
    </div>

    <div id="docs-view" class="hidden space-y-4">
        <div id="file-list" class="grid grid-cols-1 gap-2"></div>
    </div>

    <div id="vault-view" class="hidden space-y-4">
        <div id="vault-editor" class="space-y-4"></div>
        <button onclick="window.saveVault()" class="w-full py-4 bg-blue-600 rounded-xl font-black uppercase text-[10px] tracking-widest shadow-lg shadow-blue-500/20">Sync Master Profile</button>
    </div>

    <div id="settings-view" class="hidden space-y-6">
        <div class="glass p-6 rounded-2xl">
            <h3 class="text-xs font-black uppercase mb-4 text-blue-400">Secure Account</h3>
            <input id="email-in" type="email" placeholder="Email" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl mb-2 text-xs" />
            <input id="pass-in" type="password" placeholder="Password" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl mb-4 text-xs" />
            <div class="flex gap-2">
                <button onclick="window.processLogin()" class="flex-1 bg-blue-600 py-3 rounded-xl text-[9px] font-black uppercase">Link Account</button>
                <button onclick="window.processLogout()" class="flex-1 bg-red-900/20 text-red-400 py-3 rounded-xl text-[9px] font-black uppercase">Sign Out</button>
            </div>
        </div>
    </div>
  </main>
  <footer class="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-[#0f172a] via-[#0f172a] to-transparent z-50">
    <form id="chat-form" class="max-w-md mx-auto relative flex items-center gap-2">
      <input type="file" id="universal-file" class="hidden" multiple />
      <button type="button" onclick="document.getElementById('universal-file').click()" class="bg-slate-800/80 border border-slate-700 w-12 h-12 rounded-2xl flex items-center justify-center text-blue-400 text-xl font-bold">+</button>
      <div class="relative flex-1">
        <input id="chat-input" type="text" autocomplete="off" placeholder="Command (e.g. 'add Yale') or chat..." class="w-full bg-slate-800/80 border border-slate-700 rounded-2xl py-4 pl-5 pr-14 text-sm text-white outline-none focus:border-blue-500/50 transition-all" />
        <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 bg-blue-600 p-2.5 rounded-xl text-white">âž¤</button>
      </div>
    </form>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword, linkWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, onSnapshot, query, orderBy, addDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject, listAll } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-storage.js";

    const config = JSON.parse(document.getElementById("firebase-config").textContent);
    const app = initializeApp(config);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentUser = null;
    const tabs = ["log", "chat", "docs", "vault", "settings"];

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        document.getElementById("auth-status").textContent = user.isAnonymous ? "Guest Mode (Securing Data...)" : user.email;
        initSystem();
      } else { signInAnonymously(auth); }
    });

    window.processLogin = async () => {
      const email = document.getElementById("email-in").value;
      const pass = document.getElementById("pass-in").value;
      try {
        const cred = EmailAuthProvider.credential(email, pass);
        if (auth.currentUser.isAnonymous) {
            await linkWithCredential(auth.currentUser, cred);
            alert("Guest account successfully upgraded!");
        } else {
            await signInWithEmailAndPassword(auth, email, pass);
        }
      } catch (e) { alert("Auth Error: " + e.message); }
    };
    window.lookupAndAdd = async (target) => {
      try {
        const response = await fetch(`http://universities.hipolabs.com/search?name=${encodeURIComponent(target)}`);
        const data = await response.json();
        const uni = data[0] || { name: target, domains: ["unknown.edu"] };
        
        // Carnegie Logic
        const r1Keywords = ["Yale", "Harvard", "Purdue", "MIT", "Stanford", "Columbia", "Berkeley", "Princeton", "Caltech"];
        const isR1 = r1Keywords.some(k => uni.name.includes(k));
        const tier = isR1 ? "Carnegie R1" : "R2 / Research Institution";

        const id = uni.name.toLowerCase().replace(/\s/g, "-");
        await setDoc(doc(db, "users", currentUser.uid, "universities", id), {
          name: uni.name,
          domain: uni.domains[0],
          tier: tier,
          timestamp: Date.now(),
          deadline: "",
          waiver: "Pending",
          intel: "",
          piMatch: ""
        });

        await addDoc(collection(db, "global_chat"), {
          text: `[System] Logged: ${uni.name} as ${tier}.`,
          uid: "system", timestamp: Date.now()
        });
      } catch (err) {
        console.error("API Error, using fallback:", err);
        const id = target.toLowerCase().replace(/\s/g, "-");
        await setDoc(doc(db, "users", currentUser.uid, "universities", id), {
          name: target, tier: "Manual Entry", timestamp: Date.now()
        });
      }
    };

    window.switchTab = (tab) => {
      tabs.forEach(t => {
        document.getElementById(`${t}-view`).classList.add("hidden");
        document.getElementById(`tab-${t}`).classList.remove("active-tab");
        document.getElementById(`tab-${t}`).classList.add("text-slate-500");
      });
      document.getElementById(`${tab}-view`).classList.remove("hidden");
      document.getElementById(`tab-${tab}`).classList.add("active-tab");
    };
    function syncUnis() {
      const q = query(collection(db, "users", currentUser.uid, "universities"), orderBy("timestamp", "desc"));
      onSnapshot(q, (snap) => {
        document.getElementById("stats-total").textContent = `${snap.docs.length} Schools`;
        document.getElementById("uni-list").innerHTML = snap.docs.map(d => {
          const u = d.data();
          const id = d.id;
          return `
            <div class="glass p-4 rounded-2xl space-y-3">
              <div class="flex justify-between items-start">
                <div>
                  <h3 class="text-xs font-black text-blue-400 uppercase tracking-tighter">${u.name}</h3>
                  <p class="text-[7px] font-bold text-slate-500 uppercase tracking-widest">${u.tier || 'R1 Candidate'}</p>
                </div>
                <button onclick="window.deleteUni('${id}', '${u.name}')" class="text-slate-600 hover:text-red-400">âœ•</button>
              </div>
              
              <div class="grid grid-cols-2 gap-2">
                <div class="bg-slate-900/50 p-2 rounded-lg border border-slate-700/30">
                  <label class="text-[7px] uppercase font-black text-slate-500 block">Deadline</label>
                  <input type="text" value="${u.deadline || ''}" placeholder="e.g. Jan 15" 
                    onchange="window.updateUniField('${id}', 'deadline', this.value)" 
                    class="bg-transparent text-[10px] w-full outline-none text-emerald-400 font-bold" />
                </div>
                <div class="bg-slate-900/50 p-2 rounded-lg border border-slate-700/30">
                  <label class="text-[7px] uppercase font-black text-slate-500 block">Fee Waiver</label>
                  <select onchange="window.updateUniField('${id}', 'waiver', this.value)" 
                    class="bg-transparent text-[10px] w-full outline-none text-blue-400 font-bold">
                    <option value="Pending" ${u.waiver === 'Pending' ? 'selected' : ''}>Pending</option>
                    <option value="Confirmed" ${u.waiver === 'Confirmed' ? 'selected' : ''}>Confirmed</option>
                    <option value="N/A" ${u.waiver === 'N/A' ? 'selected' : ''}>N/A</option>
                  </select>
                </div>
              </div>

              <div class="flex gap-2">
                <button onclick="window.openScholar('${u.name}')" class="flex-1 bg-slate-800 py-2 rounded-lg text-[8px] font-black uppercase text-blue-300">Google Scholar</button>
                <button onclick="window.openPortal('${u.domain}')" class="flex-1 bg-slate-800 py-2 rounded-lg text-[8px] font-black uppercase text-slate-400 italic">Apply Portal</button>
              </div>
            </div>`;
        }).join("");
      });
    }

    window.updateUniField = async (id, field, val) => {
      await updateDoc(doc(db, "users", currentUser.uid, "universities", id), { [field]: val });
    };

    window.openScholar = (name) => {
      const query = encodeURIComponent(`${name} Physical Chemistry mordenite kinetics`);
      window.open(`https://scholar.google.com/scholar?q=${query}`, '_blank');
    };
    function syncChat() {
      const q = query(collection(db, "global_chat"), orderBy("timestamp", "asc"));
      onSnapshot(q, (snap) => {
        const container = document.getElementById("chat-messages");
        container.innerHTML = snap.docs.map(d => {
          const m = d.data();
          const isMe = m.uid === currentUser.uid;
          const isSystem = m.uid === "system";
          return `
            <div class="flex ${isMe ? 'justify-end' : 'justify-start'} group">
              <div class="max-w-[85%] relative">
                <div class="p-3 rounded-2xl text-[11px] leading-relaxed ${isSystem ? 'bg-blue-900/20 text-blue-300 italic border border-blue-500/20' : isMe ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-200'}">
                  ${m.text}
                </div>
                ${isMe ? `<button onclick="window.deleteMsg('${d.id}')" class="absolute -left-6 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 text-red-500 text-[10px]">âœ•</button>` : ''}
              </div>
            </div>`;
        }).join("");
        container.scrollTop = container.scrollHeight;
      });
    }

    document.getElementById("chat-form").onsubmit = async (e) => {
      e.preventDefault();
      const input = document.getElementById("chat-input");
      const val = input.value.trim();
      if (!val) return;

      if (val.toLowerCase().startsWith("add ")) {
        const name = val.replace(/^add\s+/i, "");
        // Feature: Command Echo visibility
        await addDoc(collection(db, "global_chat"), { text: `System: Logging New Target [${name}]...`, uid: "system", timestamp: Date.now() });
        window.lookupAndAdd(name);
      } else {
        await addDoc(collection(db, "global_chat"), { text: val, uid: currentUser.uid, timestamp: Date.now() });
      }
      input.value = "";
    };

    window.deleteMsg = async (id) => { await deleteDoc(doc(db, "global_chat", id)); };
    window.deleteUni = async (id, name) => { if (confirm(`Remove ${name}?`)) await deleteDoc(doc(db, "users", currentUser.uid, "universities", id)); };
    function wireFileUpload() {
      const fileInput = document.getElementById("universal-file");
      fileInput.onchange = async (e) => {
        const files = Array.from(e.target.files);
        for (const file of files) {
          const storageRef = ref(storage, `users/${currentUser.uid}/docs/${file.name}`);
          try {
            await addDoc(collection(db, "global_chat"), { text: `System: Uploading ${file.name}...`, uid: "system", timestamp: Date.now() });
            await uploadBytes(storageRef, file);
            syncFiles();
          } catch (err) { alert("Upload failed: " + err.message); }
        }
      };
    }

    function syncFiles() {
      const listRef = ref(storage, `users/${currentUser.uid}/docs`);
      listAll(listRef).then((res) => {
        const container = document.getElementById("file-list");
        if (res.items.length === 0) {
          container.innerHTML = `<p class="text-[9px] text-slate-600 uppercase text-center py-10">No documents secured yet.</p>`;
          return;
        }
        container.innerHTML = "";
        res.items.forEach(async (itemRef) => {
          const url = await getDownloadURL(itemRef);
          container.innerHTML += `
            <div class="glass p-3 rounded-xl flex justify-between items-center">
              <div class="flex items-center gap-3">
                <span class="text-xl">ðŸ“„</span>
                <div>
                  <p class="text-[10px] font-bold text-slate-200 truncate max-w-[150px]">${itemRef.name}</p>
                  <a href="${url}" target="_blank" class="text-[8px] text-blue-400 font-black uppercase">View/Download</a>
                </div>
              </div>
              <button onclick="window.deleteFile('${itemRef.fullPath}')" class="text-slate-600 text-xs">âœ•</button>
            </div>`;
        });
      });
    }

    window.deleteFile = async (path) => {
      if (confirm("Delete this document forever?")) {
        await deleteObject(ref(storage, path));
        syncFiles();
      }
    };
    window.exportAllData = async () => {
      const uniSnap = await getDoc(collection(db, "users", currentUser.uid, "universities"));
      const vaultSnap = await getDoc(doc(db, "users", currentUser.uid, "profile", "vault"));
      
      const backup = {
        applicant: "Yewilsaw Chanie",
        timestamp: new Date().toISOString(),
        log: [],
        vault: vaultSnap.exists() ? vaultSnap.data() : {}
      };

      // Create downloadable file
      const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `Academic_Agent_Backup_${new Date().toLocaleDateString()}.json`;
      a.click();
      alert("System Backup Generated Successfully.");
    };

    window.deleteMultiple = async () => {
      const pass = prompt("Enter 'DELETE' to clear all university entries:");
      if (pass === "DELETE") {
        const q = query(collection(db, "users", currentUser.uid, "universities"));
        const snap = await getDoc(q);
        const batch = writeBatch(db);
        snap.forEach(d => batch.delete(d.ref));
        await batch.commit();
        alert("Log Cleared.");
      }
    };

    function initSystem() {
      syncUnis();
      syncChat();
      syncFiles();
      loadVault();
      wireFileUpload();
      // Swipe setup from Part 2 goes here
      const mc = new Hammer(document.getElementById("swipe-zone"));
      mc.on("swipeleft", () => {
        const idx = tabs.indexOf(tabs.find(t => !document.getElementById(`${t}-view`).classList.contains("hidden")));
        if (idx < tabs.length - 1) window.switchTab(tabs[idx + 1]);
      });
      mc.on("swiperight", () => {
        const idx = tabs.indexOf(tabs.find(t => !document.getElementById(`${t}-view`).classList.contains("hidden")));
        if (idx > 0) window.switchTab(tabs[idx - 1]);
      });
    }
  </script>
</body>
</html>
