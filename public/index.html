<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Elementa SPA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family:system-ui,sans-serif; background:#f4f7fa; }
    header { background:#007bff; color:white; padding:16px; text-align:center; }
    nav { display:flex; justify-content:center; background:#0056b3; flex-wrap:wrap; }
    nav button { flex:1; padding:12px; border:none; background:#0056b3; color:white; cursor:pointer; }
    nav button.active { background:#003d80; }
    main { max-width:960px; margin:20px auto; padding:0 20px; }
    section { display:none; background:white; border-radius:8px; padding:20px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    section.active { display:block; }
    h2 { color:#007bff; }
    .inputRow { display:flex; gap:8px; margin-top:12px; }
    .inputRow input[type="text"] { flex:1; padding:8px; }
    .inputRow button { padding:8px 12px; background:#007bff; color:white; border:none; cursor:pointer; }
    #logoutBtn { margin-top:12px; padding:8px 12px; background:#dc3545; color:white; border:none; cursor:pointer; }
    #messageList p, #uploadList p { margin:4px 0; }
    aside h3 { margin-top:0; }
  </style>
</head>
<body>
  <header>
    <h1>Elementa</h1>
    <p>Universal hub: feed, messages, calls, streams</p>
  </header>

  <!-- Guest view -->
  <section id="guest" class="active">
    <h2>Welcome to Elementa</h2>
    <form id="signupForm">
      <input type="email" id="email" placeholder="Email" required>
      <input type="password" id="password" placeholder="Password" required>
      <button type="submit">Sign Up</button>
    </form>
    <p id="signupStatus"></p>
    <div class="preview">
      <h3>Trending Posts</h3>
      <p>Sample post preview...</p>
    </div>
  </section>

  <!-- Dashboard view -->
  <section id="dashboard" style="display:none;">
    <nav>
      <button data-tab="home" class="active">Home</button>
      <button data-tab="feed">Feed</button>
      <button data-tab="messages">Messages</button>
      <button data-tab="calls">Calls</button>
      <button data-tab="streams">Streams</button>
      <button data-tab="uploads">Uploads</button>
    </nav>
    <main>
      <section id="home" class="active">
        <h2>Home</h2>
        <p>Welcome back, <span id="username">User</span>!</p>
        <button id="logoutBtn">Logout</button>
      </section>

      <!-- Feed with sidebar -->
      <section id="feed">
        <h2>Feed</h2>
        <div style="display:flex; gap:20px;">
          <div style="flex:3;">
            <input type="search" id="feedSearch" placeholder="Search topics, posts, or users..." />
            <div id="feedPosts"></div>
          </div>
          <aside style="flex:1; background:#f9f9f9; padding:12px; border-radius:8px;">
            <h3>Trending Topics</h3>
            <ul id="trendingList"></ul>
            <h3 style="margin-top:20px;">Trending Streams</h3>
            <ul id="streamList"></ul>
          </aside>
        </div>
      </section>

      <!-- Messages -->
      <section id="messages">
        <h2>Messages</h2>
        <div id="messageList"></div>
        <div class="inputRow">
          <input type="text" id="messageInput" placeholder="Type a message..." />
          <button id="sendMessageBtn">Send</button>
        </div>
      </section>

      <!-- Calls -->
      <section id="calls"><h2>Calls</h2><p>1:1 and group calls via WebRTC.</p></section>

      <!-- Streams -->
      <section id="streams">
        <h2>Streams</h2>
        <p>Discover trending streams in the sidebar, or start your own broadcast.</p>
        <button id="goLiveBtn">Go Live</button>
        <video id="localStream" autoplay playsinline muted style="width:100%; margin-top:12px; border-radius:8px;"></video>
      </section>

      <!-- Uploads -->
      <section id="uploads">
        <h2>Uploads</h2>
        <input type="file" id="fileInput" />
        <button id="uploadBtn">Upload</button>
        <div id="uploadStatus"></div>
        <div id="uploadList"></div>
      </section>
    </main>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, sendEmailVerification, onAuthStateChanged, signOut } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, orderBy, query, where, limit, doc, getDoc } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // Replace with your Firebase config
    const firebaseConfig = {
      "apiKey": "AIzaSyB9fmgduk-bcSRTPL6FdcKKgqvTtQoICpE",
    "authDomain": "university-outreach-log.firebaseapp.com",
    "projectId": "university-outreach-log",
    "storageBucket": "university-outreach-log.firebasestorage.app",
    "messagingSenderId": "566149647802",
    "appId": "1:566149647802:web:490c7cc3d10b7cd7732183"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Sign-up
    document.getElementById("signupForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await sendEmailVerification(userCredential.user);
        document.getElementById("signupStatus").textContent = "Account created! Verification email sent.";
      } catch (error) {
        document.getElementById("signupStatus").textContent = `Error: ${error.code}`;
      }
    });

    // Auth state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById("guest").style.display = "none";
        document.getElementById("dashboard").style.display = "block";
        document.getElementById("username").textContent = user.email;
      } else {
        document.getElementById("guest").style.display = "block";
        document.getElementById("dashboard").style.display = "none";
      }
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
    });

    // Tab navigation
    const buttons = document.querySelectorAll("nav button");
    const sections = document.querySelectorAll("#dashboard main section");
    buttons.forEach(btn => {
      btn.addEventListener("click", () => {
        buttons.forEach(b => b.classList.remove("active"));
        sections.forEach(s => s.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(btn.dataset.tab).classList.add("active");
      });
    });

    // Messages
    const sendBtn = document.getElementById("sendMessageBtn");
    const messageInput = document.getElementById("messageInput");
    const messageList = document.getElementById("messageList");

    sendBtn.addEventListener("click", async () => {
      const text = message
            // Messages handler (continued)
      const text = messageInput.value.trim();
      if (text) {
        await addDoc(collection(db, "messages"), {
          text,
          uid: auth.currentUser ? auth.currentUser.uid : "guest",
          createdAt: serverTimestamp()
        });
        messageInput.value = "";
      }
    });

    // Real-time listener for messages
    const messagesQuery = query(collection(db, "messages"), orderBy("createdAt", "asc"));
    onSnapshot(messagesQuery, (snapshot) => {
      messageList.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const p = document.createElement("p");
        p.textContent = `${data.uid}: ${data.text}`;
        messageList.appendChild(p);
      });
    });

    // Uploads
    const uploadBtn = document.getElementById("uploadBtn");
    const fileInput = document.getElementById("fileInput");
    const uploadStatus = document.getElementById("uploadStatus");
    const uploadList = document.getElementById("uploadList");

    uploadBtn.addEventListener("click", () => {
      const file = fileInput.files[0];
      if (file) {
        const path = `uploads/${Date.now()}_${file.name}`;
        const storageRef = ref(storage, path);
        const task = uploadBytesResumable(storageRef, file);

        task.on("state_changed",
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            uploadStatus.textContent = `Upload is ${progress.toFixed(0)}% done`;
          },
          (error) => {
            uploadStatus.textContent = "Error: " + error.message;
          },
          async () => {
            const url = await getDownloadURL(task.snapshot.ref);
            uploadStatus.textContent = `Uploaded! File URL: ${url}`;
            await addDoc(collection(db, "uploads"), {
              name: file.name,
              type: file.type,
              size: file.size,
              url,
              uid: auth.currentUser ? auth.currentUser.uid : "guest",
              createdAt: serverTimestamp()
            });
          }
        );
      } else {
        uploadStatus.textContent = "No file selected.";
      }
    });

    // Real-time listener for uploads
    const uploadsQuery = query(collection(db, "uploads"), orderBy("createdAt", "desc"));
    onSnapshot(uploadsQuery, (snapshot) => {
      uploadList.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const p = document.createElement("p");
        p.innerHTML = `<strong>${data.name}</strong> (${data.type}) - <a href="${data.url}" target="_blank">View</a>`;
        uploadList.appendChild(p);
      });
    });

    // Feed
    const feedPosts = document.getElementById("feedPosts");
    const feedSearch = document.getElementById("feedSearch");
    const trendingList = document.getElementById("trendingList");
    const streamList = document.getElementById("streamList");

    let currentQuery = query(collection(db, "posts"), orderBy("createdAt", "desc"));

    function renderPosts(snapshot) {
      feedPosts.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const article = document.createElement("article");
        article.className = "post";
        article.innerHTML = `
          <h3>@${data.author}</h3>
          <p>${data.content}</p>
          <div class="actions">
            <button>Like</button>
            <button>Comment</button>
            <button>Share</button>
          </div>`;
        feedPosts.appendChild(article);
      });
    }

    onSnapshot(currentQuery, renderPosts);

    feedSearch.addEventListener("input", (e) => {
      const term = e.target.value.trim().toLowerCase();
      if (term) {
        const searchQuery = query(collection(db, "posts"), orderBy("createdAt", "desc"));
        onSnapshot(searchQuery, renderPosts);
      } else {
        onSnapshot(currentQuery, renderPosts);
      }
    });

    // Trending topics
    const trendingQuery = query(collection(db, "topics"), orderBy("count", "desc"), limit(5));
    onSnapshot(trendingQuery, (snapshot) => {
      trendingList.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const li = document.createElement("li");
        li.textContent = `${data.name} (${data.count})`;
        li.style.cursor = "pointer";
        li.addEventListener("click", () => {
          const topicQuery = query(collection(db, "posts"), orderBy("createdAt", "desc"));
          onSnapshot(topicQuery, renderPosts);
        });
        trendingList.appendChild(li);
      });
    });

    // Trending streams
    const streamsQuery = query(collection(db, "streams"), orderBy("viewers", "desc"), limit(5));
    onSnapshot(streamsQuery, (snapshot) => {
      streamList.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const li = document.createElement("li");
        li.innerHTML = `<strong>${data.title}</strong> by @${data.host} (${data.viewers} viewers) 
          <a href="${data.url}" target="_blank">Watch</a>`;
        li.style.cursor = "pointer";
        li.addEventListener("click", async () => {
          // Viewer join flow (simplified)
          const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
          const remoteVideo = document.createElement("video");
          remoteVideo.autoplay = true;
          remoteVideo.playsInline = true;
          remoteVideo.style.width = "100%";
          document.getElementById("streams").appendChild(remoteVideo);
          pc.ontrack = (event) => { remoteVideo.srcObject = event.streams[0]; };
          // Placeholder: fetch offer/answer via Firestore signaling
          console.log("Viewer clicked stream:", data.title);
        });
        streamList.appendChild(li);
      });
    });

    // Go Live
    const goLiveBtn = document.getElementById("goLiveBtn");
    const localVideo = document.getElementById("localStream");

    goLiveBtn.addEventListener("click", async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = stream;
        const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
        stream.getTracks().forEach(track => pc.addTrack(track, stream));
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await addDoc(collection(db, "streams"), {
          title: "My Live Stream",
          host: auth.currentUser ? auth.currentUser.uid : "guest",
          viewers: 0,
          createdAt: serverTimestamp(),
          url: "webrtc://placeholder",
          offer: offer.sdp
        });
        console.log("Go Live started. Offer created.");
      } catch (err) {
        console.error("Error starting live stream:", err);
      }
    });
  </script>
</body>
   </html>
   
